---
title: "Infinite Factor Demo"
author: "Evan Poworoznek"
date: "4/11/2019"
output: html_document
---

```{r include = FALSE}
library(tidyverse)
library(bayesSurv)
library(GIGrvg)
library(statmod)
library(MCMCpack)
source("regint.R")
source("clustalign.R")
source("mcrotfact.R")
```

#Generate the data

```{r}
k0 = 5
p = 20
n = 100

lambda = matrix(rnorm(p*k0, 0, 0.01), ncol = k0)
lambda[sample.int(p, 40, replace = TRUE) +
       p*(sample.int(k0, 40, replace = TRUE)-1)] = rnorm(40, 0, 1)
lambda[1:7, 1] = rnorm(7, 2, 0.5)
lambda[8:14, 2] = rnorm(7, -2, 0.5)
lambda[15:20, 3] = rnorm(6, 2, 0.5)
lambda[,4] = rnorm(p, 0, 0.5)
lambda[,5] = rnorm(p, 0, 0.5)
image(t(lambda))
```

Now we generate the outocome accorting with a linear regression with pairwise interactions

```{r}
n = 500;
X = matrix(rnorm(n*k0),n,k0)%*%t(lambda) + bayesSurv::rMVNorm(n,Sigma = 3*diag(p))
X = scale(X)

# maybe heatmap correlation on X
beta_true = numeric(p); beta_true[c(1,3,6,8,10,11)] =c(1,1,0.5,-1,-2,-0.5)
Omega_true = matrix(0,p,p)
Omega_true[1,2] = 1; Omega_true[5,2] = -1; Omega_true[10,8] = 1; 
Omega_true[11,5] = -2; Omega_true[1,1] = 1; 
Omega_true[2,3] = 0.5; 
Omega_true = Omega_true + t(Omega_true)
y = X%*%beta_true + diag(X%*%Omega_true%*%t(X)) +  rnorm(n,0.5)
```


# FIN - Bayesian Factor Model for INteractions
Model
\begin{align}
& y_i = \eta_i^T \omega + \eta_i^T \Omega \eta_i +\epsilon_{y,i},  \quad \epsilon_{y,i} \sim N(0,\sigma^2) \nonumber  \\ 
& X_i = \Lambda \eta_i+ \epsilon_i,   \quad  \epsilon_i \sim N_p(0,\Psi) \\
& \eta_i \sim N_k(0,I) \nonumber
\end{align}

The induced regression is $E(y_i | X_i) = tr (\Omega V)+(\omega^T A) X_i + X_i^T (A^T \Omega A) X_i$ where $V = (\Lambda^T \Psi^{-1} \Lambda + I)^{-1}$ and $A = V \Lambda^T \Psi^{-1}  = (\Lambda^T \Psi^{-1} \Lambda + I)^{-1} \Lambda^T \Psi^{-1}$.


DL prior
\begin{align*}
\lambda_{j,h} | \phi_j, \tau_j \sim DE(\phi_{j,h} \tau_j) \ \ \ \ \ \ \ h = 1, \cdots, k  \\
\phi_j \sim Dir(a,\cdots,a) \ \ \ \ \ \ \tau_j \sim Gamma(k a , 1/2)
\end{align*}

```{r}
source("regint_DL_last.R")
nrun = 2500; burn = 2000; thin = 1; k = 6
gibbs = gibbs_DL(y, X ,nrun, burn, thin = 1, 
               delta_rw = 0.04, epsilon_rw = 0.5,
               a = 1/2, k = k)

```

```{r}
# check results, some plotting
beta_hat = apply(gibbs$beta_bayes, 2, mean)
Omega_hat = apply(gibbs$Omega_bayes, c(2,3), mean)
#plot(gibbs$beta_bayes[,1],ty="l")
cbind(beta_true,beta_hat)
plot(beta_true,beta_hat)
Omega_true;Omega_hat
cbind(Omega_true,Omega_hat)
Omega_hat[11,5]
plot(Omega_true,Omega_hat)
```


# Postprocessing

```{r}
lambda_sample = gibbs$Lambda
```