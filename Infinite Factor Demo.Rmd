---
title: "Infinite Factor Demo"
author: "Evan Poworoznek"
date: "4/11/2019"
output: html_document
---

```{r include = FALSE}
library(tidyverse)
library(bayesSurv)
library(GIGrvg)
library(statmod)
library(MCMCpack)
source("regint.R")
source("clustalign.R")
source("permfact.R")
source("permuter.R")
source("mcrotfact.R")
```

# Generate the data


In our simulated study, we observe three families of chemicals, that show high correlation within each family. In particular, we can think of each chemical of a linear combinantion of latent factors. 




```{r}
set.seed(1)
k0 = 5
p = 20
n = 100

lambda = matrix(rnorm(p*k0, 0, 0.01), ncol = k0)
lambda[sample.int(p, 40, replace = TRUE) +
       p*(sample.int(k0, 40, replace = TRUE)-1)] = rnorm(40, 0, 1)
lambda[1:7, 1] = rnorm(7, 2, 0.5)
lambda[8:14, 2] = rnorm(7, -2, 0.5)
lambda[15:20, 3] = rnorm(6, 2, 0.5)
lambda[,4] = rnorm(p, 0, 0.5)
lambda[,5] = rnorm(p, 0, 0.5)
image(t(lambda))
```

Now we generate the outocome accorting with a linear regression with pairwise interactions. First family has a positive effect on the health response and second family negative...

```{r}
n = 500;
X = matrix(rnorm(n*k0),n,k0)%*%t(lambda) + bayesSurv::rMVNorm(n,Sigma = 3*diag(p))
X = scale(X)

# maybe heatmap correlation on X
beta_true = numeric(p); beta_true[c(1,3,6,8,10,11)] =c(1,1,0.5,-1,-2,-0.5)
Omega_true = matrix(0,p,p)
Omega_true[1,2] = 1; Omega_true[5,2] = -1; Omega_true[10,8] = 1; 
Omega_true[11,5] = -2; Omega_true[1,1] = 1; 
Omega_true[2,3] = 0.5; 
Omega_true = Omega_true + t(Omega_true)
y = X%*%beta_true + diag(X%*%Omega_true%*%t(X)) +  rnorm(n,0.5)
```


# FIN - Bayesian Factor Model for INteractions (FIN)

Let $y_i$ denote a continuous health response for individual $i$, let $X_i = (x_{i1},\cdots,x_{ip})$ denote a vector of exposure measurements. We propose a latent factor joint model, which includes shared factors in both the predictor and response components while assuming conditional independence. We include interactions among latent variables in the response component. We also assume that, given the latent variables, the explanatory variables and the response are continuous and normally distributed. We assume that the data have been standardized prior to the analysis so that we omit the intercept.
\begin{align}
& y_i = \eta_i^T \omega + \eta_i^T \Omega \eta_i +\epsilon_{y,i},  \quad \epsilon_{y,i} \sim N(0,\sigma^2) \nonumber,  \\ 
& X_i = \Lambda \eta_i+ \epsilon_i,   \quad  \epsilon_i \sim N_p(0,\Psi), \\
& \eta_i \sim N_k(0,I), \nonumber
\end{align}
We can show that induced regression of $X_i$ on $y_i$ is indeed a quadratic regression, i.e. :
$$E(y_i | X_i) = tr (\Omega V)+(\omega^T A) X_i + X_i^T (A^T \Omega A) X_i$$ 
where $V = (\Lambda^T \Psi^{-1} \Lambda + I)^{-1}$ and $A = V \Lambda^T \Psi^{-1}  = (\Lambda^T \Psi^{-1} \Lambda + I)^{-1} \Lambda^T \Psi^{-1}$.

DL prior, describe row-wise shrinkage.
\begin{align*}
\lambda_{j,h} | \phi_j, \tau_j \sim DE(\phi_{j,h} \tau_j) \ \ \ \ \ \ \ h = 1, \cdots, k  \\
\phi_j \sim Dir(a,\cdots,a) \ \ \ \ \ \ \tau_j \sim Gamma(k a , 1/2)
\end{align*}

```{r}
source("regint_DL_last.R")
<<<<<<< HEAD
nrun = 10; burn = 5; thin = 1; k = 6
=======
nrun = 5000; burn = 2000; thin = 1; k = 5
>>>>>>> b2a390730ff8832ef2d4aa1aff665a534f2cc6b7
gibbs = gibbs_DL(y, X ,nrun, burn, thin = 1, 
               delta_rw = 0.04, epsilon_rw = 0.5,
               a = 1/2, k = k)

```

```{r}
# check results, some plotting
beta_hat = apply(gibbs$beta_bayes, 2, mean)
Omega_hat = apply(gibbs$Omega_bayes, c(2,3), mean)
#plot(gibbs$beta_bayes[,1],ty="l")
cbind(beta_true,beta_hat)
plot(beta_true,beta_hat)
Omega_true;Omega_hat
Omega_hat[11,5]
plot(gibbs$Omega_bayes[,11,5],ty="l")
```


# Postprocessing

```{r}
lambda_sample = gibbs$Lambda
lambda_sample = lapply(1:500, function(ind) lambda_sample[ind,,])
sample_mean = reduce(lambda_sample, `+`)/length(lambda_sample)
aligned = clustalign(lambda_sample)
rotated = mcrotfact(aligned, method = "varimax", file = FALSE)
par(mfrow = c(1, 3))
image(t(sample_mean))
title("sample mean")
image(t(rotated$mean))
title("post-processed sample mean")
image(t(lambda))
title("original ")
```